---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import SchemaOrg from "../components/SchemaOrg.astro";
import youtubeLiteUrl from "../scripts/youtube-lite.ts?url";
import { SEO, siteConfig } from "../data/config";
import { themeSetting } from "../data/config";
const { theme } = themeSetting;

const { SiteName, Separator, defaultDescription } = SEO;

interface Props {
	title?: string;
	description?: string;
	image?: string;
	footerCta?: {
		title: string;
		description: string;
		hideCta: boolean;
		button: {
			text: string;
			link: string;
			target?: string;
		};
	};
	canonicalUrl?: string;
}

const { title, description, image, footerCta, canonicalUrl } = Astro.props;

const site = {
        url: siteConfig.siteUrl,
        name: siteConfig.companyName,
        twitter: siteConfig.Socials.xSocial || "",
};

const normalizedSiteName = SiteName || site.name;
const baseTitle = title || "";
const shouldAppendSiteName = baseTitle
        ? !baseTitle.toLowerCase().includes("cefem") && !baseTitle.toLowerCase().includes(normalizedSiteName.toLowerCase())
        : false;
const pageTitle = baseTitle
        ? shouldAppendSiteName
                ? `${baseTitle} ${Separator} ${normalizedSiteName}`
                : baseTitle
        : normalizedSiteName;
const pageDescription = description || defaultDescription || "";
const canonicalPath = canonicalUrl || Astro.url.pathname;
const fullCanonicalUrl = new URL(canonicalPath, site.url).toString();
const pageImage = image ? new URL(image, site.url).toString() : "";

---

<!doctype html>
<html lang="es-AR" class="scroll-smooth">
<head>
                <meta charset="UTF-8" />
                <meta name="viewport" content="width=device-width" />
                <link rel="icon" type="image/x-icon" href="/favicon.ico" />
                <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
                <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
                <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
                <link rel="sitemap" href="/sitemap-index.xml" />
                <link rel="canonical" href={fullCanonicalUrl} />
                <meta name="generator" content={Astro.generator} />
                <title>{pageTitle}</title>
                <meta name="description" content={pageDescription} />
                <meta name="robots" content="index, follow" />
                <meta property="og:site_name" content={site.name} />
                <meta property="og:type" content="website" />
                <meta property="og:url" content={fullCanonicalUrl} />
                <meta property="og:title" content={pageTitle} />
                <meta property="og:description" content={pageDescription} />
                {pageImage && <meta property="og:image" content={pageImage} />}
                <meta name="twitter:card" content="summary_large_image" />
                {site.twitter && <meta name="twitter:site" content={site.twitter} />}
                <meta name="twitter:title" content={pageTitle} />
                <meta name="twitter:description" content={pageDescription} />
                {pageImage && <meta name="twitter:image" content={pageImage} />}
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link rel="preconnect" href="https://www.youtube-nocookie.com">
                <link rel="preconnect" href="https://i.ytimg.com">
                <link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" onload="this.rel='stylesheet'">
                <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"></noscript>
                <SchemaOrg />
        </head>
	<body data-theme={theme}>
		<a href="#main-content" class="skip-link">Saltar al contenido principal</a>
		<Header />
		<main id="main-content">
			<slot />
		</main>
		<Footer {footerCta} />

		<!-- Floating WhatsApp Button -->
		<div class="fixed bottom-5 right-5 z-50 flex flex-col items-end gap-3">
			<div
				id="whatsappPrompt"
				class="rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 shadow-lg opacity-0 translate-y-2 transition-all duration-300 pointer-events-none"
				aria-live="polite"
			>
				Necesit√°s un turno? Escribinos.
			</div>
			<a
				id="whatsappCta"
				href="https://wa.me/5493471341461"
				target="_blank"
				rel="noopener noreferrer"
				aria-label="Contactar por WhatsApp"
				class="bg-green-500 text-white p-3 rounded-full shadow-lg hover:bg-green-600 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
			>
				<span class="sr-only">Contactar por WhatsApp</span>
				<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7" aria-hidden="true">
					<path d="M17.472 14.382c-.297-.149-1.758-.867-2.031-.967-.273-.099-.472-.148-.672.15-.198.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.135-.134.297-.346.446-.519.149-.173.198-.297.298-.495.099-.198.05-.372-.025-.521-.075-.149-.672-1.611-.921-2.206-.242-.58-.487-.502-.672-.512-.173-.009-.372-.011-.571-.011-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.099 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 5.392h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.519-5.261c.001-5.45 4.436-9.883 9.885-9.883 2.641 0 5.122 1.03 6.988 2.897a9.825 9.825 0 0 1 2.896 6.988c-.003 5.45-4.438 9.884-9.876 9.884m8.413-18.297C19.125 1.445 15.714 0 12.002 0 5.376 0 0 5.373 0 11.993c0 2.113.555 4.178 1.602 5.998L.057 24l6.182-1.623a11.94 11.94 0 0 0 5.761 1.466h.005c6.623 0 11.998-5.373 12-11.994a11.87 11.87 0 0 0-3.486-8.41" />
				</svg>
			</a>
		</div>

		<!-- Scroll to Top Button -->
		<a id="scrollToTopBtn" href="#" aria-label="Volver arriba" class="fixed bottom-5 left-5 z-50 bg-gray-700 text-white p-3 rounded-full shadow-lg hover:bg-gray-800 transition-opacity duration-300 opacity-0 pointer-events-none">
			<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-7 h-7">
				<path d="m18 15-6-6-6 6"/>
			</svg>
		</a>

                <script is:inline>
                        document.addEventListener('DOMContentLoaded', () => {

                                const observer = new IntersectionObserver((entries) => {
					entries.forEach((entry) => {
						if (entry.isIntersecting) {
							entry.target.classList.add('is-visible');
							observer.unobserve(entry.target);
						}
					});
				}, { threshold: 0.1 });

				const targets = document.querySelectorAll('.animate-on-scroll');
				targets.forEach(target => observer.observe(target));

		 
				const scrollToTopBtn = document.getElementById('scrollToTopBtn');
				if (scrollToTopBtn) {
					window.addEventListener('scroll', () => {
						if (window.scrollY > 300) {
							scrollToTopBtn.classList.remove('opacity-0', 'pointer-events-none');
						} else {
							scrollToTopBtn.classList.add('opacity-0', 'pointer-events-none');
						}
					}, { passive: true });
				}

				const whatsappPrompt = document.getElementById('whatsappPrompt');
				const whatsappCta = document.getElementById('whatsappCta');
				let whatsappPromptShown = false;
				let whatsappPromptTimeoutId = null;

				const setPageInert = (isInert) => {
					const header = document.querySelector('header');
					const main = document.getElementById('main-content');
					const footer = document.querySelector('footer');
					[header, main, footer].forEach((el) => {
						if (!el) return;
						if (isInert) {
							el.setAttribute('inert', '');
							el.setAttribute('aria-hidden', 'true');
						} else {
							el.removeAttribute('inert');
							el.removeAttribute('aria-hidden');
						}
					});
				};


				const showWhatsappPrompt = () => {
					if (!whatsappPrompt || whatsappPromptShown) {
						return;
					}
					whatsappPromptShown = true;
					if (whatsappPromptTimeoutId) {
						clearTimeout(whatsappPromptTimeoutId);
					}
					whatsappPrompt.classList.remove('opacity-0', 'translate-y-2');
					whatsappPrompt.classList.add('opacity-100', 'translate-y-0');
				};

				if (whatsappPrompt) {
					const scrollTriggerRatio = 0.4;
					const bottomTriggerOffset = 800;
					whatsappPromptTimeoutId = setTimeout(showWhatsappPrompt, 8000);
					const handlePromptScroll = () => {
						const documentHeight = Math.max(document.body.scrollHeight, document.documentElement.scrollHeight);
						const scrollableDistance = Math.max(documentHeight - window.innerHeight, 1);
						const scrolledRatio = window.scrollY / scrollableDistance;
						const scrolledBeyondTop = scrolledRatio >= scrollTriggerRatio;
						const viewportBottom = window.scrollY + window.innerHeight;
						const nearImportantSections = documentHeight - viewportBottom < bottomTriggerOffset;
						if (scrolledBeyondTop || nearImportantSections) {
							showWhatsappPrompt();
							window.removeEventListener('scroll', handlePromptScroll);
						}
					};
					window.addEventListener('scroll', handlePromptScroll, { passive: true });
				}

				if (whatsappCta) {
					const revealOnInteract = () => showWhatsappPrompt();
					whatsappCta.addEventListener('focus', revealOnInteract, { once: true });
					whatsappCta.addEventListener('mouseenter', revealOnInteract, { once: true });
				}

				const releaseScroll = () => {
					const openModals = document.querySelectorAll('[data-interview-modal]:not(.hidden)');
					if (!openModals.length) {
						document.documentElement.style.removeProperty('overflow');
						document.body.style.removeProperty('overflow');
						setPageInert(false);
					}
				};


					// (Optimizaci√≥n) la p√°gina entrevistas inicializa sus propios handlers
                        });
                </script>
                <script type="module" src={youtubeLiteUrl}></script>
                <script is:inline>
                        window.addEventListener('cefem:video_play', (event) => {
                                const detail = event?.detail || {};
                                const videoId = detail.id;
                                if (!videoId) {
                                        return;
                                }

                                if (typeof window !== 'undefined' && window.dataLayer) {
                                        window.dataLayer.push({
                                                event: 'cefem_video_play',
                                                video_id: videoId,
                                                page_path: window.location.pathname,
                                        });
                                }

                                if (typeof window !== 'undefined') {
                                        const analytics = window.analytics;
                                        if (analytics && typeof analytics.track === 'function') {
                                                analytics.track('video_play', {
                                                        id: videoId,
                                                        page: window.location.pathname,
                                                });
                                        }
                                }
                        });
                </script>
        </body>
</html>
<style>
	.skip-link {
		position: absolute;
		left: -9999px;
		top: auto;
		width: 1px;
		height: 1px;
		overflow: hidden;
		z-index: -9999;
	}
	.skip-link:focus, .skip-link:active {
		left: auto;
		top: auto;
		width: auto;
		height: auto;
		margin: 1rem;
		padding: 1rem;
		background: #fff;
		color: #000;
		border: 1px solid #ccc;
		position: static;
		overflow: auto;
		z-index: 9999;
	}
	#main-content {
		/* Opcional: asegura que el ancla funcione correctamente */
		scroll-margin-top: 100px; /* Ajusta este valor a la altura de tu header fijo */
	}

	/* Estilos para la animaci√≥n de scroll */
	.animate-on-scroll {
		opacity: 0;
		transform: scale(0.95);
		transition: opacity 0.4s ease-out, transform 0.4s ease-out;
	}

	.animate-on-scroll.is-visible {
		opacity: 1;
		transform: scale(1);
	}
</style>
